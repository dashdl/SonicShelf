<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhongxin.sonicshelf.mapper.MusicMapper">

    <resultMap id="MusicResponse" type="com.zhongxin.sonicshelf.dto.response.MusicResponse">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="cover_image" property="coverImage"/>
        <result column="artist_name" property="artistName"/>
        <result column="artist_id" property="artistId"/>
        <result column="album_title" property="albumTitle"/>
        <result column="album_id" property="albumId"/>
    </resultMap>

    <select id="findAsPageByListId" resultMap="MusicResponse">
        SELECT m.id,
               m.title,
               m.cover_image,
               a.name   as artist_name,
               a.id   as artist_id,
               am.title as album_title,
               am.id    as album_id,
               m.duration,
               m.file_url
        FROM musics m
                 LEFT JOIN playlist_musics pm ON pm.music_id = m.id
                 LEFT JOIN playlists p ON p.id = pm.playlist_id
                 LEFT JOIN artists a ON m.artist_id = a.id
                 LEFT JOIN albums am On am.id = m.album_id
        WHERE p.id = #{id}
    </select>
    <select id="findById" resultType="com.zhongxin.sonicshelf.dto.response.MusicResponse">

    </select>
    <select id="selectById" resultType="com.zhongxin.sonicshelf.dto.response.MusicResponse">
        SELECT m.id,
               m.title,
               m.cover_image,
               a.name   as artist_name,
               a.id     as artist_id,
               am.title as album_title,
               am.id    as album_id,
               m.duration,
               m.file_url
        FROM musics m
                 INNER JOIN artists a ON m.artist_id = a.id
                 INNER JOIN albums am On am.id = m.album_id
        WHERE m.id = #{id}
    </select>

    <select id="selectByIds" resultType="com.zhongxin.sonicshelf.dto.response.MusicInfoResponse">
        SELECT m.id,
        m.title,
        m.cover_image,
        a.name as artist_name,
        am.title as album_title,
        am.id as album_id,
        m.duration,
        m.file_url
        FROM musics m
        LEFT JOIN artists a ON m.artist_id = a.id
        LEFT JOIN albums am ON am.id = m.album_id
        WHERE m.id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

    <select id="selectMusicsByArtistId" resultType="com.zhongxin.sonicshelf.dto.response.MusicResponse">
        SELECT m.id,
               m.title,
               m.cover_image,
               a.name   as artist_name,
               a.id     as artist_id,
               am.title as album_title,
               am.id    as album_id,
               m.duration,
               m.file_url
        FROM musics m
                 INNER JOIN artists a ON m.artist_id = a.id
                 INNER JOIN albums am On am.id = m.album_id
        WHERE a.id = #{id}
    </select>
    <select id="selectMusicsByAlbumId" resultType="com.zhongxin.sonicshelf.dto.response.MusicResponse">
        SELECT m.id,
               m.title,
               m.cover_image,
               a.name   as artist_name,
               a.id     as artist_id,
               am.title as album_title,
               am.id    as album_id,
               m.duration,
               m.file_url
        FROM musics m
                 INNER JOIN artists a ON m.artist_id = a.id
                 INNER JOIN albums am On am.id = m.album_id
        WHERE am.id = #{id}
    </select>
    <select id="selectMusicsByIds" resultType="com.zhongxin.sonicshelf.dto.response.MusicResponse">
        SELECT m.id,
        m.title,
        m.cover_image,
        a.name as artist_name,
        a.id as artist_id,
        am.title as album_title,
        am.id as album_id,
        m.duration,
        m.file_url
        FROM musics m
        INNER JOIN artists a ON m.artist_id = a.id
        INNER JOIN albums am On am.id = m.album_id
        WHERE m.id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>
    <select id="selectMusics" resultType="com.zhongxin.sonicshelf.dto.response.MusicManageResponse">
        SELECT m.id,
        m.title,
        a.id as artist_id,
        a.name as artist_name,
        am.id as album_id,
        am.title as album_title,
        m.duration,
        m.file_url,
        m.lyrics,
        m.cover_image,
        m.play_count,
        m.created_at,
        m.updated_at
        FROM musics m
        INNER JOIN artists a ON m.artist_id = a.id
        INNER JOIN albums am On am.id = m.album_id
        <where>
            <if test="artistId != null">
                a.id = #{artistId}
            </if>
            <if test="albumId != null">
                and am.id = #{albumId}
            </if>
            <if test="keyword != null and keyword != ''">
                and (m.title like concat('%', #{keyword}, '%')
                or a.name like concat('%', #{keyword}, '%') )
            </if>
            <if test="categoryIds != null and categoryIds != '' and categoryIds.length > 0">
                AND EXISTS (
                SELECT 1 FROM music_categories mc
                WHERE mc.music_id = m.id AND mc.category_id in
                <foreach collection="categoryIds" item="id" open="(" close=")" separator=",">
                    #{id}
                </foreach>
                )
            </if>
        </where>
    </select>
    <select id="selectMusicManageResponseById" resultType="com.zhongxin.sonicshelf.dto.response.MusicManageResponse">
        SELECT m.id,
               m.title,
               a.id     as artist_id,
               a.name   as artist_name,
               am.id    as album_id,
               am.title as album_title,
               m.duration,
               m.file_url,
               m.lyrics,
               m.cover_image,
               m.play_count,
               m.created_at,
               m.updated_at
        FROM musics m
                 INNER JOIN artists a ON m.artist_id = a.id
                 INNER JOIN albums am On am.id = m.album_id
        WHERE m.id = #{id}
    </select>
    <select id="selectPlaylistMusicResponseByPlaylistId" resultType="com.zhongxin.sonicshelf.dto.response.PlaylistMusicResponse">
        SELECT m.id,
               m.title,
               a.name   as artist_name,
               am.title as album_title,
               m.cover_image,
               m.duration
        FROM musics m
                 LEFT JOIN playlist_musics pm ON pm.music_id = m.id
                 LEFT JOIN playlists p ON p.id = pm.playlist_id
                 LEFT JOIN artists a ON m.artist_id = a.id
                 LEFT JOIN albums am On am.id = m.album_id
        WHERE p.id = #{playlistId}
    </select>
    <select id="selectMusicsFromHistories" resultType="com.zhongxin.sonicshelf.dto.response.MusicResponse">
        SELECT m.id,
               m.title,
               m.cover_image       as coverImage,
               a.name              as artistName,
               a.id                as artistId,
               am.title            as albumTitle,
               am.id               as albumId,
               m.duration,
               m.file_url          as fileUrl,
               latest_ph.play_time as playTime
        FROM musics m
                 INNER JOIN artists a ON m.artist_id = a.id
                 INNER JOIN albums am ON am.id = m.album_id
                 INNER JOIN (SELECT music_id, MAX(play_time) as max_play_time
                             FROM play_histories
                             WHERE user_id = #{currentUserId}
                             GROUP BY music_id) latest ON latest.music_id = m.id
                 INNER JOIN play_histories latest_ph
                            ON latest_ph.music_id = latest.music_id AND latest_ph.play_time = latest.max_play_time AND
                               latest_ph.user_id = #{currentUserId}
        ORDER BY latest_ph.play_time DESC
    </select>

<!--    #         SELECT m.id,-->
<!--    #                m.title,-->
<!--    #                m.cover_image,-->
<!--    #                a.name as artist_name,-->
<!--    #                a.id as artist_id,-->
<!--    #                am.title as album_title,-->
<!--    #                am.id as album_id,-->
<!--    #                m.duration,-->
<!--    #                m.file_url-->
<!--    #         FROM musics m-->
<!--    #                  INNER JOIN artists a ON m.artist_id = a.id-->
<!--    #                  INNER JOIN albums am ON am.id = m.album_id-->
<!--    #                  INNER JOIN play_histories as ph ON ph.music_id = m.id-->
<!--    #                  INNER JOIN users as u ON ph.user_id = u.id-->
<!--    #         WHERE ph.user_id = #{currentUserId}-->

</mapper>